<!DOCTYPE html>
<html>
<head>
    <title>Регистрация ИКО</title>
    <style>
        :root { --bg:#0b0f14; --panel:#0f1520; --panel2:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#f97316; --accent2:#fb923c; --error:#ef4444; --success:#22c55e; }
        * { box-sizing: border-box }
        html, body { height: 100% }
        body { margin:0; background: radial-gradient(1200px 600px at 20% -10%, rgba(249,115,22,.15), transparent 60%), radial-gradient(1000px 500px at 120% 0%, rgba(251,146,60,.12), transparent 50%), linear-gradient(180deg, #0b0f14 0%, #0a0d12 100%); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; display:flex; align-items:center; justify-content:center; padding: 32px }
        .card { width: 100%; max-width: 560px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.05); border-radius: 16px; overflow:hidden; box-shadow: 0 10px 40px rgba(0,0,0,.4); backdrop-filter: blur(6px) }
        .header { padding: 22px 24px; background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.6)); display:flex; align-items:center; gap:12px }
        .badge { height: 10px; width: 10px; border-radius:9999px; background: radial-gradient(circle at 30% 30%, var(--accent2), var(--accent)); box-shadow: 0 0 12px rgba(249,115,22,.6) }
        .title { font-weight: 700; letter-spacing:.2px }
        .body { padding: 22px 24px; background: linear-gradient(180deg, rgba(15,21,32,.85), rgba(11,15,20,.85)) }
        .subtitle { margin: 0 0 18px 0; color: var(--muted) }
        .form-group { margin-bottom: 16px }
        label { display:block; margin:0 0 6px 0; font-size: 12px; color: var(--muted); letter-spacing:.2px }
        input { width:100%; padding: 12px 14px; background: #0c1118; color: var(--text); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; outline: none; transition: border .2s, box-shadow .2s }
        input[readonly] { color:#9aa3ad }
        input:focus { border-color: rgba(249,115,22,.55); box-shadow: 0 0 0 4px rgba(249,115,22,.12) }
        .actions { margin-top: 8px; display:flex; align-items:center; gap:12px }
        button { appearance:none; border:0; border-radius: 12px; padding: 12px 16px; color:#0a0d12; font-weight:700; cursor:pointer; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 10px 20px rgba(249,115,22,.25), inset 0 0 0 1px rgba(255,255,255,.15); transition: transform .06s ease, filter .2s }
        button:hover { filter: brightness(1.05) }
        button:active { transform: translateY(1px) }
        .helper { font-size: 12px; color: var(--muted) }
        .success { color: var(--success); margin-top: 10px }
        .error { color: var(--error); margin-top: 10px }
        .error-box { margin-top: 12px; padding: 12px 14px; border-radius: 12px; background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.35); color: #fecaca }
        .glow { position: absolute; inset: -2px; border-radius: 18px; background: radial-gradient(600px 80px at 20% -20%, rgba(249,115,22,.15), transparent 60%), radial-gradient(400px 120px at 120% 0%, rgba(251,146,60,.12), transparent 60%); filter: blur(14px); z-index: -1 }
        .wrap { position: relative }
    </style>
</head>
<body>
    <div class="card wrap">
      <div class="glow"></div>
      <div class="header"><div class="badge"></div><div class="title">Регистрация</div></div>
      <div class="body">
        <p class="subtitle">Заполните данные для роли ИКО</p>
        <form id="registrationForm">
            <div class="form-group">
                <label>ФИО</label>
                <input type="text" id="full_name" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" required readonly>
            </div>
            <div class="form-group">
                <label>Телефон</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label>Роль</label>
                <input type="text" id="role" value="iko" readonly>
            </div>
            <div class="form-group">
                <label>Пароль</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-group">
                <label>Подтверждение пароля</label>
                <input type="password" id="password_confirm" required>
            </div>
            <div class="actions">
              <button type="submit">Зарегистрироваться</button>
              <div class="helper">Проверьте корректность email</div>
            </div>
        </form>
        <div id="message"></div>
      </div>
    </div>

    <script>
        document.getElementById('email').value = new URLSearchParams(window.location.search).get('email') || '';

        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            
            const p1 = document.getElementById('password').value;
            const p2 = document.getElementById('password_confirm').value;
            if (p1.length < 8 || p2.length < 8) {
                document.getElementById('message').innerHTML = '<div class="error-box">Пароль должен быть не менее 8 символов</div>';
                btn.disabled = false;
                return;
            }
            if (p1 !== p2) {
                document.getElementById('message').innerHTML = '<div class="error-box">Пароли не совпадают</div>';
                btn.disabled = false;
                return;
            }
            
            const formData = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                password1: document.getElementById('password').value,
                password2: document.getElementById('password_confirm').value,
                phone: document.getElementById('phone').value,
                role: 'iko'
            };

            try {
                const response = await fetch('https://building-api.itc-hub.ru/api/v1/auth/register-by-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                let raw = await response.text();
                let result = {};
                try { result = JSON.parse(raw); } catch(e) {}
                
                if (response.ok) {
                    document.querySelectorAll('input').forEach(i=>i.readOnly=true);
                    btn.disabled = true;
                    document.getElementById('message').innerHTML = '<div class="success">Регистрация успешна!</div>';
                    setTimeout(() => { window.location.href = 'https://building.itc-hub.ru/login/'; }, 600);
                } else {
                    if (result && typeof result === 'object') {
                        const items = [];
                        for (const k in result) {
                            const val = Array.isArray(result[k]) ? result[k].join(', ') : String(result[k]);
                            items.push(`<li><b>${k}</b>: ${val}</li>`);
                        }
                        document.getElementById('message').innerHTML = '<div class="error-box"><div>Ошибка:</div><ul style="margin:8px 0 0 16px">' + items.join('') + '</ul></div>';
                    } else {
                        const msg = (result && (result.message || result.detail)) || raw || 'Неизвестная ошибка';
                        document.getElementById('message').innerHTML = '<div class="error-box">Ошибка: ' + msg + '</div>';
                    }
                }
            } catch (error) {
                document.getElementById('message').innerHTML = '<div class="error">Ошибка соединения: ' + error.message + '</div>';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
